<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Bolão 42</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #efeff3;
            --tg-theme-hint-color: #999999;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 16px;
            padding-bottom: 80px;
        }

        .section-title { font-size: 14px; font-weight: 600; color: var(--tg-theme-button-color); text-transform: uppercase; margin: 20px 0 8px 4px; }
        
        .card { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 12px; margin-bottom: 16px; }

        .dt-input {
            width: 100%; padding: 12px; border: none; border-radius: 8px; margin-bottom: 8px;
            background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); font-size: 16px;
        }

        .game-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .game-row:last-child { border: none; }
        .game-info { flex: 1; font-size: 15px; }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .chip {
            padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500;
            background: var(--tg-theme-bg-color); border: 1px solid var(--tg-theme-button-color);
            color: var(--tg-theme-button-color); cursor: pointer; transition: 0.2s;
        }
        .chip.selected { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
        .chip.disabled { opacity: 0.5; border-color: var(--tg-theme-hint-color); color: var(--tg-theme-hint-color); cursor: not-allowed; }

        .btn-main {
            position: fixed; bottom: 16px; left: 16px; right: 16px;
            padding: 16px; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--tg-theme-button-color); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div class="section-title">Prazo Global de Encerramento</div>
    <div class="card">
        <input type="date" id="input-data" class="dt-input">
        <input type="time" id="input-hora" class="dt-input">
    </div>

    <div id="container-rodadas"></div>

    <button class="btn-main" onclick="submit()">CRIAR RODADA(S)</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let rodadasData = {};
        let usuariosData = [];
        let configuracao = {};

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const raw = urlParams.get('data');
            
            if (!raw) {
                document.body.innerHTML = "<h3>Erro: Dados não recebidos</h3>";
                return;
            }

            try {
                const decoded = JSON.parse(atob(raw));
                rodadasData = decoded.rodadas;
                usuariosData = decoded.usuarios;
                render();
            } catch (e) {
                tg.showAlert("Erro ao processar dados da URL.");
            }
        }

        function render() {
            const container = document.getElementById('container-rodadas');
            
            for (const rNum in rodadasData) {
                configuracao[rNum] = { jogos: [], dobradas: [] };
                
                const rodadaSection = document.createElement('div');
                rodadaSection.innerHTML = `<div class="section-title">Rodada ${rNum}</div>`;
                
                // Card de Jogos
                const cardJogos = document.createElement('div');
                cardJogos.className = 'card';
                rodadasData[rNum].forEach(jogo => {
                    const row = document.createElement('div');
                    row.className = 'game-row';
                    row.innerHTML = `
                        <div class="game-info">${jogo.home} x ${jogo.away}</div>
                        <label class="switch">
                            <input type="checkbox" checked onchange="toggleJogo('${rNum}', '${jogo.id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    `;
                    cardJogos.appendChild(row);
                    configuracao[rNum].jogos.push(jogo.id);
                });
                rodadaSection.appendChild(cardJogos);

                // Card de Estrelas (Dobradas)
                const labelEstrela = document.createElement('div');
                labelEstrela.className = 'section-title';
                labelEstrela.innerText = `Usuários c/ Estrela na Rd ${rNum}`;
                rodadaSection.appendChild(labelEstrela);

                const cardUsers = document.createElement('div');
                cardUsers.className = 'card chips-container';
                
                usuariosData.forEach(user => {
                    const chip = document.createElement('div');
                    // ja_usou_estrela == 0 significa que ele ainda tem a estrela disponível
                    const temDisponivel = user.ja_usou_estrela === 0;
                    
                    chip.className = `chip ${temDisponivel ? 'selected' : 'disabled'}`;
                    chip.innerText = user.nome;
                    
                    if (temDisponivel) {
                        configuracao[rNum].dobradas.push(user.id);
                        chip.onclick = () => {
                            chip.classList.toggle('selected');
                            toggleEstrela(rNum, user.id);
                        };
                    }
                    cardUsers.appendChild(chip);
                });
                rodadaSection.appendChild(cardUsers);
                container.appendChild(rodadaSection);
            }
        }

        function toggleJogo(rNum, id, isChecked) {
            if (isChecked) configuracao[rNum].jogos.push(id);
            else configuracao[rNum].jogos = configuracao[rNum].jogos.filter(i => i !== id);
        }

        function toggleEstrela(rNum, userId) {
            const index = configuracao[rNum].dobradas.indexOf(userId);
            if (index > -1) configuracao[rNum].dobradas.splice(index, 1);
            else configuracao[rNum].dobradas.push(userId);
        }

        function submit() {
            const data = document.getElementById('input-data').value;
            const hora = document.getElementById('input-hora').value;
            
            if (!data || !hora) {
                tg.showAlert("⚠️ Defina a data e hora de encerramento!");
                return;
            }

            const payload = {
                config_multipla: {
                    hora_encerramento: `${data} ${hora}`,
                    rodadas: configuracao
                }
            };

            tg.sendData(JSON.stringify(payload));
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => tg.close(), 300);
        }

        init();
    </script>
</body>
</html>
